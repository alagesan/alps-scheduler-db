<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALPS DB Based Scheduler - API Test Page</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .api-config {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 30px;
        }

        .api-config label {
            font-weight: 600;
            margin-right: 10px;
        }

        .api-config input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            width: 400px;
            font-size: 14px;
        }

        .endpoints {
            display: grid;
            gap: 15px;
        }

        .endpoint-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .endpoint-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .endpoint-header {
            background: #f8f9fa;
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .endpoint-header:hover {
            background: #e9ecef;
        }

        .endpoint-method {
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }

        .method-get { background: #28a745; }
        .method-post { background: #007bff; }
        .method-put { background: #ffc107; color: black; }
        .method-delete { background: #dc3545; }

        .endpoint-path {
            flex: 1;
            font-family: 'Courier New', monospace;
            color: #2c3e50;
            font-weight: 600;
        }

        .endpoint-description {
            color: #7f8c8d;
            font-size: 14px;
        }

        .endpoint-body {
            padding: 15px;
            display: none;
            background: white;
        }

        .endpoint-body.active {
            display: block;
        }

        .param-group {
            margin-bottom: 15px;
        }

        .param-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .param-group input,
        .param-group select,
        .param-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }

        .param-group textarea {
            font-family: 'Courier New', monospace;
        }

        .param-group input:focus,
        .param-group select:focus,
        .param-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .test-button {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
        }

        .test-button:hover {
            background: #5568d3;
        }

        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .response-section {
            margin-top: 15px;
            display: none;
        }

        .response-section.active {
            display: block;
        }

        .response-header {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .response-box {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            max-height: 400px;
            overflow: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }

        .response-box.success {
            border-color: #28a745;
            background: #d4edda;
        }

        .response-box.error {
            border-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .status-200, .status-201, .status-204 {
            background: #28a745;
            color: white;
        }

        .status-error {
            background: #dc3545;
            color: white;
        }

        .category-header {
            color: white;
            padding: 12px 15px;
            border-radius: 5px;
            margin: 20px 0 15px 0;
            font-size: 16px;
            font-weight: bold;
        }

        .category-schedule { background: #28a745; }
        .category-master { background: #007bff; }
        .category-users { background: #6f42c1; }

        /* Menu Navigation */
        .menu-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .menu-button {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 8px;
            padding: 10px 14px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.2s ease;
        }

        .menu-button:hover {
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .menu-icon {
            font-size: 1.5rem;
            color: #667eea;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 220px;
            overflow: hidden;
            display: none;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            color: #2c3e50;
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 1px solid #eee;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #f0f0ff;
            color: #667eea;
        }

        .dropdown-item.active {
            background: #f0f0ff;
            color: #667eea;
            border-left: 3px solid #667eea;
        }

        .dropdown-icon {
            font-size: 1.1rem;
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
            display: none;
        }

        .menu-overlay.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
    <div class="menu-container">
        <button class="menu-button" onclick="toggleMenu()">
            <span class="menu-icon">‚ò∞</span>
        </button>
        <div class="dropdown-menu" id="dropdownMenu">
            <a href="/" class="dropdown-item">
                <span class="dropdown-icon">üè†</span>
                Home
            </a>
            <a href="/batch/" class="dropdown-item">
                <span class="dropdown-icon">üìß</span>
                Batch Control
            </a>
            <a href="/batch/master.html" class="dropdown-item">
                <span class="dropdown-icon">üìã</span>
                Manage Task Master
            </a>
            <a href="/batch/users.html" class="dropdown-item">
                <span class="dropdown-icon">üë•</span>
                Manage Users
            </a>
            <a href="/api-test/" class="dropdown-item active">
                <span class="dropdown-icon">üîß</span>
                Test API
            </a>
        </div>
    </div>

    <div class="container">
        <h1>ALPS DB Based Scheduler API Test Page</h1>
        <p class="subtitle">Test Schedule Retrieval and Task Master Management APIs</p>

        <div class="api-config">
            <label>API Base URL:</label>
            <input type="text" id="apiBaseUrl" value="/api">
            <span style="color: #7f8c8d; font-size: 12px; margin-left: 10px;">
                Auto-configured (served from API container)
            </span>
        </div>

        <div class="endpoints" id="endpoints"></div>
    </div>

    <script>
        // Authentication helpers
        function getAuthHeaders() {
            const token = localStorage.getItem('jwt_token');
            return {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            };
        }

        function checkAuth() {
            const token = localStorage.getItem('jwt_token');
            if (!token) {
                alert('Please login first from the Home page');
                window.location.href = '/';
                return false;
            }
            return true;
        }

        // Check auth on page load
        if (!checkAuth()) {
            throw new Error('Not authenticated');
        }

        // Menu toggle function
        function toggleMenu() {
            const menu = document.getElementById('dropdownMenu');
            const overlay = document.getElementById('menuOverlay');
            menu.classList.toggle('show');
            overlay.classList.toggle('show');
        }

        const apiBaseUrlInput = document.getElementById('apiBaseUrl');
        const endpointsContainer = document.getElementById('endpoints');
        const endpointConfigs = {};

        const today = new Date().toISOString().split('T')[0];
        const currentYear = new Date().getFullYear();
        const currentMonth = new Date().getMonth() + 1;
        const currentQuarter = Math.floor(new Date().getMonth() / 3) + 1;
        const currentHalf = new Date().getMonth() < 6 ? 1 : 2;

        const endpoints = [
            {
                category: "Schedule Endpoints - Date Based Task Retrieval",
                categoryClass: "category-schedule",
                items: [
                    {
                        method: "GET",
                        path: "/schedule/today",
                        description: "Get scheduled tasks for today",
                        params: []
                    },
                    {
                        method: "GET",
                        path: "/schedule/date/{date}",
                        description: "Get scheduled tasks for a specific date",
                        params: [
                            { name: "date", type: "date", label: "Date", default: today, placeholder: "YYYY-MM-DD" }
                        ]
                    },
                    {
                        method: "GET",
                        path: "/schedule/week",
                        description: "Get scheduled tasks for current week",
                        params: []
                    },
                    {
                        method: "GET",
                        path: "/schedule/week/{date}",
                        description: "Get scheduled tasks for week containing date",
                        params: [
                            { name: "date", type: "date", label: "Date", default: today, placeholder: "YYYY-MM-DD" }
                        ]
                    },
                    {
                        method: "GET",
                        path: "/schedule/month/{year}/{month}",
                        description: "Get scheduled tasks for a specific month",
                        params: [
                            { name: "year", type: "number", label: "Year", default: currentYear },
                            { name: "month", type: "number", label: "Month (1-12)", default: currentMonth }
                        ]
                    },
                    {
                        method: "GET",
                        path: "/schedule/quarter/{year}/{quarter}",
                        description: "Get scheduled tasks for a quarter",
                        params: [
                            { name: "year", type: "number", label: "Year", default: currentYear },
                            { name: "quarter", type: "number", label: "Quarter (1-4)", default: currentQuarter }
                        ]
                    },
                    {
                        method: "GET",
                        path: "/schedule/half-year/{year}/{half}",
                        description: "Get scheduled tasks for half-year",
                        params: [
                            { name: "year", type: "number", label: "Year", default: currentYear },
                            { name: "half", type: "number", label: "Half (1-2)", default: currentHalf }
                        ]
                    },
                    {
                        method: "GET",
                        path: "/schedule/year/{year}",
                        description: "Get scheduled tasks for entire year",
                        params: [
                            { name: "year", type: "number", label: "Year", default: currentYear }
                        ]
                    },
                    {
                        method: "GET",
                        path: "/schedule/range?start={start}&end={end}",
                        description: "Get scheduled tasks for date range",
                        params: [
                            { name: "start", type: "date", label: "Start Date", default: today },
                            { name: "end", type: "date", label: "End Date", default: new Date(Date.now() + 7*24*60*60*1000).toISOString().split('T')[0] }
                        ],
                        isQuery: true
                    }
                ]
            },
            {
                category: "Master Endpoints - Task Definition Management (CRUD)",
                categoryClass: "category-master",
                items: [
                    {
                        method: "GET",
                        path: "/master/tasks",
                        description: "Get all task master records",
                        params: []
                    },
                    {
                        method: "GET",
                        path: "/master/tasks/{rowNumber}",
                        description: "Get task master record by row number",
                        params: [
                            { name: "rowNumber", type: "number", label: "Row Number", default: 2 }
                        ]
                    },
                    {
                        method: "GET",
                        path: "/master/departments",
                        description: "Get all departments",
                        params: []
                    },
                    {
                        method: "GET",
                        path: "/master/frequencies",
                        description: "Get all frequencies",
                        params: []
                    },
                    {
                        method: "GET",
                        path: "/master/tasks/department/{department}",
                        description: "Get tasks by department",
                        params: [
                            { name: "department", type: "select", label: "Department", default: "MEP",
                              options: ["MEP", "HouseKeeping", "FrontOffice", "FnB", "Gardening"] }
                        ]
                    },
                    {
                        method: "GET",
                        path: "/master/tasks/frequency/{frequency}",
                        description: "Get tasks by frequency",
                        params: [
                            { name: "frequency", type: "select", label: "Frequency", default: "Daily",
                              options: ["Daily", "Weekly", "Monthly", "Quarterly", "Half-Yearly", "Yearly"] }
                        ]
                    },
                    {
                        method: "POST",
                        path: "/master/tasks",
                        description: "Create new task master record",
                        params: [
                            { name: "body", type: "json", label: "Request Body", default: JSON.stringify({
                                activity: "Test Task",
                                department: "MEP",
                                frequency: "Daily",
                                noOfTimes: 1,
                                specificDates: "",
                                comments: "Created via API"
                            }, null, 2) }
                        ]
                    },
                    {
                        method: "PUT",
                        path: "/master/tasks/{rowNumber}",
                        description: "Update task master record",
                        params: [
                            { name: "rowNumber", type: "number", label: "Row Number", default: 2 },
                            { name: "body", type: "json", label: "Request Body", default: JSON.stringify({
                                activity: "Updated Task",
                                department: "MEP",
                                frequency: "Weekly",
                                noOfTimes: 1,
                                specificDates: "",
                                comments: "Updated via API"
                            }, null, 2) }
                        ]
                    },
                    {
                        method: "DELETE",
                        path: "/master/tasks/{rowNumber}",
                        description: "Delete task master record",
                        params: [
                            { name: "rowNumber", type: "number", label: "Row Number", default: 27 }
                        ]
                    }
                ]
            },
            {
                category: "User Endpoints - User Management (CRUD)",
                categoryClass: "category-users",
                items: [
                    {
                        method: "GET",
                        path: "/users",
                        description: "Get all users",
                        params: []
                    },
                    {
                        method: "GET",
                        path: "/users/{rowNumber}",
                        description: "Get user by row number",
                        params: [
                            { name: "rowNumber", type: "number", label: "Row Number", default: 2 }
                        ]
                    },
                    {
                        method: "GET",
                        path: "/users/email/{email}",
                        description: "Get user by email",
                        params: [
                            { name: "email", type: "text", label: "Email", default: "admin@example.com" }
                        ]
                    },
                    {
                        method: "GET",
                        path: "/users/status/{status}",
                        description: "Get users by status",
                        params: [
                            { name: "status", type: "select", label: "Status", default: "Enabled",
                              options: ["Enabled", "Disabled"] }
                        ]
                    },
                    {
                        method: "GET",
                        path: "/users/role/{role}",
                        description: "Get users by role",
                        params: [
                            { name: "role", type: "select", label: "Role", default: "Admin",
                              options: ["Admin", "Staff", "User"] }
                        ]
                    },
                    {
                        method: "GET",
                        path: "/users/statuses",
                        description: "Get all available statuses",
                        params: []
                    },
                    {
                        method: "GET",
                        path: "/users/roles",
                        description: "Get all available roles",
                        params: []
                    },
                    {
                        method: "POST",
                        path: "/users",
                        description: "Create new user",
                        params: [
                            { name: "body", type: "json", label: "Request Body", default: JSON.stringify({
                                email: "newuser@example.com",
                                status: "Enabled",
                                role: "Staff"
                            }, null, 2) }
                        ]
                    },
                    {
                        method: "PUT",
                        path: "/users/{rowNumber}",
                        description: "Update user",
                        params: [
                            { name: "rowNumber", type: "number", label: "Row Number", default: 2 },
                            { name: "body", type: "json", label: "Request Body", default: JSON.stringify({
                                email: "updated@example.com",
                                status: "Enabled",
                                role: "Admin"
                            }, null, 2) }
                        ]
                    },
                    {
                        method: "DELETE",
                        path: "/users/{rowNumber}",
                        description: "Delete user",
                        params: [
                            { name: "rowNumber", type: "number", label: "Row Number", default: 10 }
                        ]
                    }
                ]
            }
        ];

        function renderEndpoints() {
            endpointsContainer.innerHTML = '';

            endpoints.forEach(category => {
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'category-header ' + category.categoryClass;
                categoryHeader.textContent = category.category;
                endpointsContainer.appendChild(categoryHeader);

                category.items.forEach((endpoint, index) => {
                    const card = createEndpointCard(endpoint, `${category.categoryClass}-${index}`);
                    endpointsContainer.appendChild(card);
                });
            });
        }

        function createEndpointCard(endpoint, id) {
            endpointConfigs[id] = endpoint;

            const card = document.createElement('div');
            card.className = 'endpoint-card';

            const methodClass = 'method-' + endpoint.method.toLowerCase();

            const header = document.createElement('div');
            header.className = 'endpoint-header';
            header.innerHTML = `
                <div style="display: flex; align-items: center; flex: 1;">
                    <span class="endpoint-method ${methodClass}">${endpoint.method}</span>
                    <span class="endpoint-path">${endpoint.path}</span>
                </div>
                <span class="endpoint-description">${endpoint.description}</span>
            `;

            const body = document.createElement('div');
            body.className = 'endpoint-body';
            body.id = `body-${id}`;

            let paramsHtml = '';
            if (endpoint.params.length > 0) {
                endpoint.params.forEach(param => {
                    if (param.type === 'select') {
                        paramsHtml += `
                            <div class="param-group">
                                <label>${param.label}:</label>
                                <select id="${id}-${param.name}">
                                    ${param.options.map(opt => `<option value="${opt}" ${opt === param.default ? 'selected' : ''}>${opt}</option>`).join('')}
                                </select>
                            </div>
                        `;
                    } else if (param.type === 'json') {
                        paramsHtml += `
                            <div class="param-group">
                                <label>${param.label}:</label>
                                <textarea id="${id}-${param.name}" rows="8">${param.default}</textarea>
                            </div>
                        `;
                    } else {
                        paramsHtml += `
                            <div class="param-group">
                                <label>${param.label}:</label>
                                <input type="${param.type}" id="${id}-${param.name}" value="${param.default || ''}" placeholder="${param.placeholder || ''}">
                            </div>
                        `;
                    }
                });
            }

            body.innerHTML = `
                ${paramsHtml}
                <button class="test-button" onclick="testEndpoint('${id}')" id="btn-${id}">
                    Test API
                </button>
                <div class="response-section" id="response-${id}">
                    <div class="response-header">Response:</div>
                    <div id="status-${id}"></div>
                    <div class="response-box" id="result-${id}"></div>
                </div>
            `;

            header.onclick = () => {
                body.classList.toggle('active');
            };

            card.appendChild(header);
            card.appendChild(body);

            return card;
        }

        async function testEndpoint(id) {
            const endpoint = endpointConfigs[id];

            const button = document.getElementById(`btn-${id}`);
            const responseSection = document.getElementById(`response-${id}`);
            const statusDiv = document.getElementById(`status-${id}`);
            const resultDiv = document.getElementById(`result-${id}`);

            button.disabled = true;
            button.textContent = 'Testing...';
            responseSection.classList.add('active');
            resultDiv.className = 'response-box';
            resultDiv.innerHTML = '<div class="loading">Loading...</div>';
            statusDiv.innerHTML = '';

            let url = apiBaseUrlInput.value + endpoint.path;
            let requestBody = null;

            endpoint.params.forEach(param => {
                if (param.type === 'json') {
                    requestBody = document.getElementById(`${id}-${param.name}`).value;
                } else {
                    const value = document.getElementById(`${id}-${param.name}`).value;
                    url = url.replace(`{${param.name}}`, value);
                }
            });

            try {
                const startTime = Date.now();
                const options = {
                    method: endpoint.method,
                    headers: getAuthHeaders()
                };

                if (requestBody && (endpoint.method === 'POST' || endpoint.method === 'PUT')) {
                    options.body = requestBody;
                }

                const response = await fetch(url, options);

                // Handle auth errors
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('jwt_token');
                    alert('Session expired. Please login again.');
                    window.location.href = '/';
                    return;
                }
                const endTime = Date.now();

                let data;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    data = await response.text() || '(No content)';
                }

                const statusClass = response.ok ? `status-${response.status}` : 'status-error';
                statusDiv.innerHTML = `
                    <span class="status-badge ${statusClass}">
                        Status: ${response.status} ${response.statusText}
                    </span>
                    <span class="status-badge" style="background: #6c757d; color: white; margin-left: 10px;">
                        Time: ${endTime - startTime}ms
                    </span>
                `;

                resultDiv.className = 'response-box ' + (response.ok ? 'success' : 'error');
                resultDiv.textContent = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
            } catch (error) {
                statusDiv.innerHTML = '<span class="status-badge status-error">Error</span>';
                resultDiv.className = 'response-box error';
                resultDiv.textContent = `Error: ${error.message}\n\nMake sure the API server is running.`;
            }

            button.disabled = false;
            button.textContent = 'Test API';
        }

        renderEndpoints();
    </script>
</body>
</html>
